#!/bin/bash
set -euo pipefail

REPO_ROOT=$(git rev-parse --show-toplevel)
CRATE_DIR="$REPO_ROOT/loctree_rs"

echo "ğŸ” [Pre-push] Running quality gate..."

echo ""
echo "[1/4] ğŸ¦€ cargo fmt --check..."
if (cd "$CRATE_DIR" && cargo fmt --check); then
  echo "    âœ“ formatting OK"
else
  echo "âŒ Run 'cargo fmt' in loctree_rs/ before pushing."
  exit 1
fi

echo ""
echo "[2/4] ğŸ¦€ cargo clippy..."
if (cd "$CRATE_DIR" && cargo clippy --quiet -- -D warnings); then
  echo "    âœ“ clippy OK"
else
  echo "âŒ Clippy errors. Fix before pushing."
  exit 1
fi

echo ""
echo "[3/4] ğŸ§ª cargo test..."
if (cd "$CRATE_DIR" && cargo test --quiet); then
  echo "    âœ“ tests OK"
else
  echo "âŒ Tests failed!"
  exit 1
fi

echo ""
echo "[4/4] ğŸ”„ loct cycles (self-check)..."
if (cd "$CRATE_DIR" && cargo run --quiet -- cycles 2>/dev/null); then
  echo "    âœ“ no circular imports"
else
  echo "    âš ï¸  cycles check skipped (build may be in progress)"
fi

echo ""
echo "âœ… Quality gate passed â€” push allowed."
