#!/bin/bash
set -euo pipefail

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo "ğŸ” [Pre-push] Running quality gate..."

echo ""
echo "[1/4] ğŸ¦€ cargo fmt --check..."
if cargo fmt --check; then
  echo "    âœ“ formatting OK"
else
  echo "âŒ Run 'cargo fmt' before pushing."
  exit 1
fi

echo ""
echo "[2/4] ğŸ¦€ cargo clippy..."
if cargo clippy --all-targets --all-features --quiet -- -D warnings; then
  echo "    âœ“ clippy OK"
else
  echo "âŒ Clippy errors. Fix before pushing."
  exit 1
fi

echo ""
echo "[3/4] ğŸ§ª cargo test..."
if cargo test --quiet; then
  echo "    âœ“ tests OK"
else
  echo "âŒ Tests failed!"
  exit 1
fi

echo ""
echo "[4/4] ğŸ“¦ cargo publish --dry-run..."
if cargo publish --dry-run --allow-dirty --quiet 2>/dev/null; then
  echo "    âœ“ publish dry-run OK"
else
  echo "    âš ï¸  publish dry-run skipped (may need login)"
fi

echo ""
echo "âœ… Quality gate passed â€” push allowed."
