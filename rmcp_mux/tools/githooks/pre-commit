#!/bin/bash
set -euo pipefail

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo "ğŸ” [Pre-commit] Running quality gate..."

echo ""
echo "[1/4] ğŸ¦€ cargo fmt --check..."
if cargo fmt --check; then
  echo "    âœ“ formatting OK"
else
  echo "âŒ Run 'cargo fmt' before committing."
  exit 1
fi

echo ""
echo "[2/4] ğŸ¦€ cargo clippy..."
if cargo clippy --all-targets --all-features --quiet -- -D warnings; then
  echo "    âœ“ clippy OK"
else
  echo "âŒ Clippy errors. Fix before committing."
  exit 1
fi

echo ""
echo "[3/4] ğŸ§ª cargo test..."
if cargo test --quiet; then
  echo "    âœ“ tests OK"
else
  echo "âŒ Tests failed!"
  exit 1
fi

echo ""
echo "[4/4] ğŸ” semgrep scan..."
if command -v semgrep >/dev/null 2>&1; then
  if semgrep scan --config auto --quiet --error 2>/dev/null; then
    echo "    âœ“ semgrep OK"
  else
    echo "âŒ Semgrep found issues. Fix before committing."
    exit 1
  fi
else
  echo "    âš ï¸  semgrep not installed (install via 'pipx install semgrep')"
fi

echo ""
echo "âœ… Quality gate passed â€” commit allowed."
