# Loctree CI - Self-Analysis Dogfooding
# Uses modern 0.8.0+ artifact-first commands (no deprecated flags)
#
# Vibecrafted with AI Agents by VetCoders (c)2025 The LibraxisAI Team
# Co-Authored-By: Maciej <void@div0.space> & Klaudiusz <the1st@whoai.am>

name: Loctree CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  HEALTH_THRESHOLD: 60

jobs:
  loctree-analysis:
    name: Self-Analysis Dogfooding
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: loctree-ci-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            loctree-ci-

      - uses: dtolnay/rust-toolchain@stable

      - name: Build loctree
        run: cargo build -p loctree --release

      - name: Run Full Scan (artifact-first)
        id: scan
        run: |
          echo "## ðŸŒ³ Loctree Self-Analysis" >> $GITHUB_STEP_SUMMARY

          # Modern command: loct auto generates all artifacts
          ./target/release/loct auto 2>/dev/null || true

          if [ -f .loctree/agent.json ]; then
            HEALTH=$(jq -r '.summary.health_score // 0' .loctree/agent.json)
            FILES=$(jq -r '.summary.files_analyzed // 0' .loctree/agent.json)
            DEAD=$(jq -r '.summary.dead_exports // 0' .loctree/agent.json)
            CYCLES=$(jq -r '.summary.circular_imports // 0' .loctree/agent.json)

            echo "health=$HEALTH" >> $GITHUB_OUTPUT
            echo "cycles=$CYCLES" >> $GITHUB_OUTPUT

            BADGE=$([ "$HEALTH" -ge 80 ] && echo "ðŸŸ¢" || ([ "$HEALTH" -ge 50 ] && echo "ðŸŸ¡" || echo "ðŸ”´"))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### $BADGE Health Score: ${HEALTH}/100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Files | $FILES |" >> $GITHUB_STEP_SUMMARY
            echo "| Dead exports | $DEAD |" >> $GITHUB_STEP_SUMMARY
            echo "| Cycles | $CYCLES |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Health Threshold
        if: steps.scan.outputs.health != ''
        run: |
          HEALTH=${{ steps.scan.outputs.health }}
          if [ "$HEALTH" -lt "${{ env.HEALTH_THRESHOLD }}" ]; then
            echo "::error::Health score $HEALTH below threshold (${{ env.HEALTH_THRESHOLD }})"
            exit 1
          fi

      - name: Check Circular Imports
        run: |
          # Modern command: loct cycles
          ./target/release/loct cycles 2>/dev/null || true
          CYCLES=${{ steps.scan.outputs.cycles }}
          if [ "$CYCLES" != "0" ] && [ -n "$CYCLES" ]; then
            echo "::warning::Found $CYCLES circular import(s)"
          fi

      - name: Check Dead Exports
        run: |
          # Modern command: loct dead --confidence high
          ./target/release/loct dead --confidence high --top 10 2>/dev/null || true

      - name: Generate HTML Report
        run: |
          # Modern command: loct report
          ./target/release/loct report --output loctree-report.html 2>/dev/null || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: loctree-analysis-${{ matrix.os }}
          path: |
            .loctree/
            loctree-report.html
          if-no-files-found: ignore
