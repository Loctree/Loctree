name: Loctree CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  loctree-analysis:
    name: Loctree Self-Analysis
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            loctree_rs/target
          key: loctree-ci-${{ hashFiles('loctree_rs/Cargo.lock') }}
          restore-keys: |
            loctree-ci-

      - uses: dtolnay/rust-toolchain@stable

      - name: Build loctree
        run: cd loctree_rs && cargo build --release

      - name: Analyze loctree_rs
        run: |
          ./loctree_rs/target/release/loctree loctree_rs/src -A --ext rs \
            --circular \
            --dead \
            --confidence high

      - name: Analyze reports crate
        run: |
          ./loctree_rs/target/release/loctree reports/src -A --ext rs \
            --circular \
            --dead \
            --confidence high

      - name: Analyze landing crate
        run: |
          ./loctree_rs/target/release/loctree landing/src -A --ext rs \
            --circular \
            --dead \
            --confidence high

      - name: Check for circular imports (all crates)
        run: |
          for CRATE in loctree_rs/src reports/src landing/src; do
            OUTPUT=$(./loctree_rs/target/release/loctree $CRATE -A --circular --json 2>/dev/null || true)
            CYCLES=$(echo "$OUTPUT" | jq -r '.cycles // [] | length' 2>/dev/null || echo "0")
            if [ "$CYCLES" != "0" ] && [ "$CYCLES" != "" ]; then
              echo "::warning::Found $CYCLES circular import(s) in $CRATE"
            fi
          done

      - name: Generate HTML reports
        run: |
          ./loctree_rs/target/release/loctree loctree_rs/src -A --ext rs \
            --report loctree-report.html --graph
          ./loctree_rs/target/release/loctree reports/src -A --ext rs \
            --report reports-report.html --graph
          ./loctree_rs/target/release/loctree landing/src -A --ext rs \
            --report landing-report.html --graph

      - name: Upload analysis reports
        uses: actions/upload-artifact@v4
        with:
          name: loctree-analysis-reports-${{ matrix.os }}
          path: |
            loctree-report.html
            reports-report.html
            landing-report.html
          if-no-files-found: ignore
