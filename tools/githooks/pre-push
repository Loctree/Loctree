#!/bin/sh
set -e

# Pre-push hook: runs full validation before pushing to remote
# This is more thorough than pre-commit to catch issues before they reach CI

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo "=== Pre-push validation ==="

# Get the remote and branch being pushed to
remote="$1"
url="$2"

echo "Pushing to: $remote ($url)"

# ============================================
# loctree_rs (main crate)
# ============================================
echo ""
echo "[1/11] loctree_rs: format check..."
(cd loctree_rs && cargo fmt -- --check) || {
  echo "❌ loctree_rs formatting issues. Run: cd loctree_rs && cargo fmt"
  exit 1
}

echo ""
echo "[2/11] loctree_rs: clippy..."
(cd loctree_rs && cargo clippy -- -D warnings)

echo ""
echo "[3/11] loctree_rs: tests..."
(cd loctree_rs && cargo test --quiet)

# ============================================
# reports (report-leptos crate)
# ============================================
echo ""
echo "[4/11] reports: format check..."
(cd reports && cargo fmt -- --check) || {
  echo "❌ reports formatting issues. Run: cd reports && cargo fmt"
  exit 1
}

echo ""
echo "[5/11] reports: clippy..."
(cd reports && cargo clippy -- -D warnings)

echo ""
echo "[6/11] reports: tests..."
(cd reports && cargo test --quiet)

# ============================================
# landing (landing page crate)
# ============================================
echo ""
echo "[7/11] landing: format check..."
(cd landing && cargo fmt -- --check) || {
  echo "❌ landing formatting issues. Run: cd landing && cargo fmt"
  exit 1
}

echo ""
echo "[8/11] landing: clippy..."
(cd landing && cargo clippy -- -D warnings)

# Note: landing may not have tests, so we just check compilation
echo ""
echo "[8b/11] landing: check..."
(cd landing && cargo check --quiet)

# ============================================
# Node & Python tests
# ============================================
echo ""
echo "[9/11] Node.js tests..."
node tools/tests/test_loctree_node_unit.mjs
node tools/tests/loctree-node.test.mjs

echo ""
echo "[10/11] Python tests..."
python3 tools/tests/test_loctree_py_unit.py
node tools/tests/loctree-py.test.mjs

# Run Rust integration tests
echo ""
echo "[10b/11] Rust integration tests..."
node tools/tests/loctree-rs.test.mjs

# ============================================
# Loctree dogfooding
# ============================================
echo ""
echo "[11/11] Loctree dogfooding..."
(cd loctree_rs && cargo build --release --quiet)
# Note: --dead skipped for lib crate (exports used by CLI binary outside src/)
"$REPO_ROOT/loctree_rs/target/release/loctree" "$REPO_ROOT/loctree_rs/src" -A --ext rs --circular || {
  echo "❌ Loctree dogfooding failed!"
  exit 1
}

# ============================================
# Optional: Semgrep security scan
# ============================================
if command -v semgrep >/dev/null 2>&1; then
  echo ""
  echo "[+] Semgrep security scan..."
  semgrep \
    --config p/secrets \
    --config p/owasp-top-ten \
    --config p/r2c-security-audit \
    --error --metrics=off \
    --exclude tests/fixtures --exclude loctree_rs/target --exclude reports/target --exclude landing/target \
    --quiet || {
      echo "Semgrep found issues. Fix them before pushing."
      exit 1
    }
else
  echo ""
  echo "[~] Semgrep not installed; skipping security scan."
fi

echo ""
echo "=== All pre-push checks passed ==="
