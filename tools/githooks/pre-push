#!/bin/sh
set -e

# Pre-push hook: runs full validation before pushing to remote
# This hook is scoped to core crates only (no landing/memex/mux in base repo).

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo "=== Pre-push validation ==="

remote="$1"
url="$2"
echo "Pushing to: $remote ($url)"

# ============================================
# loctree_rs (main crate)
# ============================================
echo ""
echo "[1/13] loctree_rs: format check..."
(cd loctree_rs && cargo fmt -- --check) || {
  echo "❌ loctree_rs formatting issues. Run: cd loctree_rs && cargo fmt"
  exit 1
}

echo ""
echo "[2/13] loctree_rs: clippy..."
(cd loctree_rs && cargo clippy -- -D warnings)

echo ""
echo "[3/13] loctree_rs: tests..."
(cd loctree_rs && cargo test --quiet)

# ============================================
# reports (report-leptos crate)
# ============================================
echo ""
echo "[4/13] reports: format check..."
(cd reports && cargo fmt -- --check) || {
  echo "❌ reports formatting issues. Run: cd reports && cargo fmt"
  exit 1
}

echo ""
echo "[5/13] reports: clippy..."
(cd reports && cargo clippy -- -D warnings)

echo ""
echo "[6/13] reports: tests..."
(cd reports && cargo test --quiet)

# ============================================
# loctree_server (MCP server)
# ============================================
echo ""
echo "[7/13] loctree_server: format check..."
(cd loctree_server && cargo fmt -- --check) || {
  echo "❌ loctree_server formatting issues. Run: cd loctree_server && cargo fmt"
  exit 1
}

echo ""
echo "[8/13] loctree_server: clippy..."
(cd loctree_server && cargo clippy -- -D warnings)

echo ""
echo "[9/13] loctree_server: build..."
(cd loctree_server && cargo build --quiet)

# ============================================
# Node & Python tests
# ============================================
echo ""
echo "[10/13] Node.js tests..."
node tools/tests/test_loctree_node_unit.mjs
node tools/tests/loctree-node.test.mjs

echo ""
echo "[11/13] Python tests..."
python3 tools/tests/test_loctree_py_unit.py
node tools/tests/loctree-py.test.mjs

# Run Rust integration tests
echo ""
echo "[12/13] Rust integration tests..."
node tools/tests/loctree-rs.test.mjs

# ============================================
# Loctree dogfooding
# ============================================
echo ""
echo "[13/13] Loctree dogfooding..."
cargo build -p loctree --release --quiet
# Note: --dead skipped for lib crate (exports used by CLI binary outside src/)
"$REPO_ROOT/target/release/loctree" "$REPO_ROOT/loctree_rs/src" -A --ext rs --circular || {
  echo "❌ Loctree dogfooding failed!"
  exit 1
}

# ============================================
# Optional: Semgrep security scan
# ============================================
if command -v semgrep >/dev/null 2>&1; then
  echo ""
  echo "[+] Semgrep security scan..."
  semgrep \
    --config p/secrets \
    --config p/owasp-top-ten \
    --config p/r2c-security-audit \
    --error --metrics=off \
    --exclude tests/fixtures --exclude target --exclude loctree_rs/target --exclude reports/target \
    --quiet || {
      echo "Semgrep found issues. Fix them before pushing."
      exit 1
    }
else
  echo ""
  echo "[~] Semgrep not installed; skipping security scan."
fi

echo ""
echo "=== All pre-push checks passed ==="
