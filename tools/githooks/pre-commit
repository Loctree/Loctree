#!/bin/sh
set -e

# Get repo root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo "=== Pre-commit (fast checks on staged files) ==="

# Check if any Rust files are staged
STAGED_RS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -n "$STAGED_RS" ]; then
  echo "Running Rust fmt (auto-fix)..."
  (cd loctree_rs && cargo fmt)

  # Re-add formatted files
  echo "$STAGED_RS" | xargs -I {} git add "{}" 2>/dev/null || true
fi

# Check if any JS/TS files are staged
STAGED_JS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|mjs|ts|tsx)$' || true)

if [ -n "$STAGED_JS" ]; then
  echo "Running Node unit tests..."
  node tools/tests/test_loctree_node_unit.mjs
fi

# Check if any Python files are staged
STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$STAGED_PY" ]; then
  echo "Running Python unit tests..."
  python3 tools/tests/test_loctree_py_unit.py
fi

# Quick Rust check if any .rs files staged
if [ -n "$STAGED_RS" ]; then
  echo "Running Rust quick check (cargo check)..."
  (cd loctree_rs && cargo check --quiet) || {
    echo "❌ Rust compilation errors. Fix before committing."
    exit 1
  }
fi

echo "✅ Pre-commit checks passed. Full tests run on push."
