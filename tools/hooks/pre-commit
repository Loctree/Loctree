#!/bin/sh
set -e

# Get repo root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo "=== Pre-commit (fast checks on staged files) ==="

# Check if any Rust files are staged
STAGED_RS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -n "$STAGED_RS" ]; then
  echo "Running Rust fmt (auto-fix) on all crates..."

  # Format Rust crates
  (cd loctree_rs && cargo fmt)
  (cd reports && cargo fmt)
  (cd loctree-mcp && cargo fmt)

  # Re-add formatted files
  echo "$STAGED_RS" | xargs -I {} git add "{}" 2>/dev/null || true
fi

# NOTE: Legacy Node/Python CLIs were removed. We intentionally do not run any JS/Python
# test suites here; keep this hook fast and Rust-focused.

# Quick Rust check if any .rs files staged
if [ -n "$STAGED_RS" ]; then
  echo "Running Rust quick check (cargo check) on all crates..."

  # Check which crates have staged files
  if echo "$STAGED_RS" | grep -q "^loctree_rs/"; then
    (cd loctree_rs && cargo check --quiet) || {
      echo "❌ loctree_rs compilation errors. Fix before committing."
      exit 1
    }
  fi

  if echo "$STAGED_RS" | grep -q "^reports/"; then
    (cd reports && cargo check --quiet) || {
      echo "❌ reports compilation errors. Fix before committing."
      exit 1
    }
  fi

  if echo "$STAGED_RS" | grep -q "^loctree-mcp/"; then
    (cd loctree-mcp && cargo check --quiet) || {
      echo "❌ loctree-mcp compilation errors. Fix before committing."
      exit 1
    }
  fi
fi

echo "✅ Pre-commit checks passed. Full tests run on push."
