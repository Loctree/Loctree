#!/bin/sh
set -e

# Pre-push hook: runs full validation before pushing to remote
# This is more thorough than pre-commit to catch issues before they reach CI

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo "=== Pre-push validation ==="

# Get the remote and branch being pushed to
remote="$1"
url="$2"

echo "Pushing to: $remote ($url)"

# ============================================
# loctree_rs (main crate)
# ============================================
echo ""
echo "[1/19] loctree_rs: format check..."
(cd loctree_rs && cargo fmt -- --check) || {
  echo "❌ loctree_rs formatting issues. Run: cd loctree_rs && cargo fmt"
  exit 1
}

echo ""
echo "[2/19] loctree_rs: clippy..."
(cd loctree_rs && cargo clippy -- -D warnings)

echo ""
echo "[3/19] loctree_rs: tests..."
(cd loctree_rs && cargo test --quiet)

# ============================================
# reports (report-leptos crate)
# ============================================
echo ""
echo "[4/19] reports: format check..."
(cd reports && cargo fmt -- --check) || {
  echo "❌ reports formatting issues. Run: cd reports && cargo fmt"
  exit 1
}

echo ""
echo "[5/19] reports: clippy..."
(cd reports && cargo clippy -- -D warnings)

echo ""
echo "[6/19] reports: tests..."
(cd reports && cargo test --quiet)

# ============================================
# landing (landing page crate)
# ============================================
echo ""
echo "[7/19] landing: format check..."
(cd landing && cargo fmt -- --check) || {
  echo "❌ landing formatting issues. Run: cd landing && cargo fmt"
  exit 1
}

echo ""
echo "[8/19] landing: clippy..."
(cd landing && cargo clippy -- -D warnings)

# Note: landing may not have tests, so we just check compilation
echo ""
echo "[8b/19] landing: check..."
(cd landing && cargo check --quiet)

# ============================================
# loctree-mcp (MCP server)
# ============================================
echo ""
echo "[9/19] loctree-mcp: format check..."
(cd loctree-mcp && cargo fmt -- --check) || {
  echo "❌ loctree-mcp formatting issues. Run: cd loctree-mcp && cargo fmt"
  exit 1
}

echo ""
echo "[10/19] loctree-mcp: clippy..."
(cd loctree-mcp && cargo clippy -- -D warnings)

echo ""
echo "[11/19] loctree-mcp: build..."
(cd loctree-mcp && cargo build --quiet)

# ============================================
# loctree_lsp (LSP server)
# ============================================
echo ""
echo "[12/19] loctree_lsp: format check..."
(cd loctree_lsp && cargo fmt -- --check) || {
  echo "❌ loctree_lsp formatting issues. Run: cd loctree_lsp && cargo fmt"
  exit 1
}

echo ""
echo "[13/19] loctree_lsp: clippy..."
(cd loctree_lsp && cargo clippy -- -D warnings)

echo ""
echo "[14/19] loctree_lsp: build..."
(cd loctree_lsp && cargo build --quiet)

# ============================================
# Node & Python tests
# ============================================
echo ""
echo "[15/19] Node.js tests..."
node tools/tests/test_loctree_node_unit.mjs
node tools/tests/loctree-node.test.mjs

echo ""
echo "[16/19] Python tests..."
python3.13 tools/tests/test_loctree_py_unit.py
node tools/tests/loctree-py.test.mjs

# Run Rust integration tests
echo ""
echo "[17/19] Rust integration tests..."
node tools/tests/loctree-rs.test.mjs

# ============================================
# Loctree dogfooding
# ============================================
echo ""
echo "[18/19] Loctree dogfooding..."
cargo build -p loctree --release --quiet
# Run loct on itself - use new CLI syntax
# Note: --dead skipped for lib crate (exports used by CLI binary outside src/)
(cd "$REPO_ROOT/loctree_rs" && "$REPO_ROOT/target/release/loct" cycles) || {
  echo "❌ Loctree dogfooding failed!"
  exit 1
}

# ============================================
# Optional: Semgrep security scan
# ============================================
if command -v semgrep >/dev/null 2>&1; then
  echo ""
  echo "[19/19] Semgrep security scan..."
  semgrep \
    --config p/secrets \
    --config p/owasp-top-ten \
    --config p/r2c-security-audit \
    --error --metrics=off \
    --exclude tests/fixtures --exclude tools/fixtures --exclude target --exclude loctree_rs/target --exclude reports/target --exclude landing/target \
    --quiet || {
      echo "Semgrep found issues. Fix them before pushing."
      exit 1
    }
else
  echo ""
  echo "[~] Semgrep not installed; skipping security scan."
fi

echo ""
echo "=== All pre-push checks passed ==="
